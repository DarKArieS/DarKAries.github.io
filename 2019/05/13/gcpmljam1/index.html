<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>ML Study Jam1:ä½¿ç”¨ BigQueryMLé æ¸¬è¨ˆç¨‹è»Šè²»ç‡ | è²“åœˆéƒ¨è½</title>
  
  

  

  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.6.3/css/all.min.css">
  

  

  
  <link rel="stylesheet" href="/style.css">
  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
    <!-- ga -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-130083931-1', 'http://yoursite.com');
      ga('send', 'pageview');
    </script>
  
  
</head>

<body>
    <div id="loading-bar-wrapper">
  <div id="loading-bar" class="pure"></div>
</div>

    <script>setLoadingBarProgress(20)</script>
    <header class="l_header pure">
	<div class="wrapper">
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href="/">
        
          è²“åœˆéƒ¨è½
        
      </a>
			<div class="menu">
				<ul class="h-list">
          
  					
  						<li>
								<a id="categories" class="nav flat-box" href="/categories/">
									<i class="fas fa-folder-open fa-fw"></i>&nbsp;Categories
								</a>
							</li>
      			
  						<li>
								<a id="tags" class="nav flat-box" href="/tags/">
									<i class="fas fa-hashtag fa-fw"></i>&nbsp;Tags
								</a>
							</li>
      			
  						<li>
								<a id="archives" class="nav flat-box" href="/archives/">
									<i class="fas fa-archive fa-fw"></i>&nbsp;Archives
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="æœå°‹">
						<span class="icon"><i class="fas fa-search fa-fw"></i></span>
					</form>
				</div>
			
			<ul class="switcher h-list">
				
					<li class="s-search"><a class="fas fa-search fa-fw" href="javascript:void(0)"></a></li>
				
				<li class="s-menu"><a class="fas fa-bars fa-fw" href="javascript:void(0)"></a></li>
			</ul>
		</div>

		<div class="nav-sub container container--flex">
			<a class="logo flat-box"></a>
			<ul class="switcher h-list">
				<li class="s-comment"><a class="flat-btn fas fa-comments fa-fw" href="javascript:void(0)"></a></li>
				<li class="s-toc"><a class="flat-btn fas fa-list fa-fw" href="javascript:void(0)"></a></li>
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu">
      <ul>
          
              
                  <li>
										<a id="categories" class="nav flat-box" href="/categories/">
											<i class="fas fa-folder-open fa-fw"></i>&nbsp;Categories
										</a>
                  </li>
              
                  <li>
										<a id="tags" class="nav flat-box" href="/tags/">
											<i class="fas fa-hashtag fa-fw"></i>&nbsp;Tags
										</a>
                  </li>
              
                  <li>
										<a id="archives" class="nav flat-box" href="/archives/">
											<i class="fas fa-archive fa-fw"></i>&nbsp;Archives
										</a>
                  </li>
              
       
      </ul>
		</nav>
    </header>
	</aside>

    <script>setLoadingBarProgress(40);</script>
    <div class="l_body">
    <div class='container clearfix'>
        <div class='l_main'>
            <article id="post" class="post white-box article-type-post" itemscope="" itemprop="blogPost">
  
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      
          <h1 class="title">ML Study Jam1:ä½¿ç”¨ BigQueryMLé æ¸¬è¨ˆç¨‹è»Šè²»ç‡</h1>
      
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="http://yoursite.com">
            <i class="fas fa-user" aria-hidden="true"></i>
            è²“åœˆåœˆ
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            2019-05-13
          </a>
        </div>
      
      
        
          
          <div class="new-meta-item category">
            <a href="/categories/Google-Could-Platform/">
              <i class="fas fa-folder-open" aria-hidden="true"></i>
              Google Could Platform
            </a>
          </div>
        
      
      
        
          <div class="new-meta-item browse busuanzi">
            <a class="notlink">
              <i class="fas fa-eye" aria-hidden="true"></i>
              <span id="busuanzi_value_page_pv">
                <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
              </span>
            </a>
          </div>
        
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
      <div class="article-entry" itemprop="articleBody">
        <p><a href="https://events.withgoogle.com/ml-study-jam-basic-tw/" target="_blank" rel="noopener">ML Study Jam</a></p>
<p><a href="https://google.qwiklabs.com/focuses/1797?parent=catalog" target="_blank" rel="noopener">Qwiklabsé€£çµ</a></p>
<p>å‰é™£å­<s>å¾å…¥é–€åˆ°æ”¾æ£„</s>è‡ªå­¸æ©Ÿå™¨å­¸ç¿’æ™‚å°±æœ‰è€³è Google æ¨å‡ºäº†è¨±å¤šé›²ç«¯å·¥å…·ï¼Œä¾‹å¦‚æœ¬ç¯‡æœƒä½¿ç”¨çš„ BigQuery ç­‰ç­‰ã€‚</p>
<p>ä»¥å‰è‡ªå­¸çš„æ™‚å€™çœ‹åˆ°é¡ä¼¼çš„é›²ç«¯å·¥å…·æ™‚ï¼Œç¸½æœƒè¦ºå¾—ä¸çŸ¥è©²å¾ä½•è™•ä¸‹æ‰‹æ‰å¥½ï¼Œæœ€å¾Œä¾¿ä¸‹æ„è­˜åœ°è·³éğŸ˜…</p>
<p>è€Œ Google æœ€è¿‘ç‚ºäº†æ¨å»£è‡ªå®¶çš„ GCP é›²ç«¯å¹³å°ï¼Œç™¼èµ·äº† ML Study Jam ï¼Œæä¾›å…è²»çš„ä¸€å€‹æœˆç·šä¸Šå­¸ç¿’å¹³å° Qwiklabs è¨‚é–±ã€‚é€™æ¬¡ä¸»æ‰“çš„ Qwiklabs é …ç›®æœƒæ‰‹æŠŠæ‰‹æ•™ä½ å¦‚ä½•ä½¿ç”¨ GCP ä¸Šçš„å„é …åŠŸèƒ½ï¼Œä¸æœƒæ¶‰åŠåˆ°å¤ªå¤šæ©Ÿå™¨å­¸ç¿’æŠ€è¡“æ¢è¨ã€‚ Qwiklabs æœƒæä¾›ä¸€å€‹æœ‰æ™‚é–“åŠåŠŸèƒ½é™åˆ¶çš„ GCP å¸³è™Ÿä¾›ä½ ç·´ç¿’ã€‚åœ¨æ•™å­¸ä¸­æœƒæœ‰ä¸€äº›å°é—œå¡ï¼Œç•¶ä½ åœ¨è©²å¸³è™Ÿä¸Šå®Œæˆæ™‚å°±å¯ä»¥éé—œã€‚</p>
<p>é€™é‚Šä¸æœƒä»‹ç´¹ Qwiklabs èˆ‡ GCP ä»‹é¢çš„åŸºç¤ä½¿ç”¨æ–¹å¼ï¼Œé‚„æ²’è©¦éçš„åŒå­¸å¯ä»¥å…ˆ<a href="https://google.qwiklabs.com/quests/23" target="_blank" rel="noopener">ä¾†é€™è£¡çœ‹çœ‹</a>ï¼Œç¬¬ä¸€å€‹ä»‹ç´¹ Qwiklabs èˆ‡ GCP çš„ Hands-on lab æ˜¯å…è²»çš„ã€‚</p>
<a id="more"></a>
<p>å¤§éƒ¨åˆ†åœ–ç‰‡ä¾†è‡ª Qwiklabs ã€‚</p>
<h1 id="overview"><a class="header-anchor" href="#overview">Â¶</a>Overview</h1>
<p><a href="https://cloud.google.com/bigquery/" target="_blank" rel="noopener">BigQuery</a>æ˜¯ Google æ¨å‡ºçš„ç„¡ä¼ºæœå™¨ä¼æ¥­è³‡æ–™å€‰å„²æœå‹™ï¼ŒåŒæ™‚å…§å»º <a href="https://cloud.google.com/bigquery/docs/bigqueryml-analyst-start" target="_blank" rel="noopener">BigQuery MachineLearning</a> åŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥åœ¨é›²ç«¯ä¸Šå°‡è³‡æ–™ç”¨æ–¼ training ã€ evaluation ã€ prediction ç­‰ç­‰ã€‚</p>
<p>é€™ç¯‡æ–‡ç« æ‰€åƒè€ƒçš„ Lab å°‡æœƒä½¿ç”¨ BigQuery ä¸­çš„å…¬é–‹æ•¸æ“šé›†â€”â€” New york city taxi cab 2015 ä¾†å»ºç«‹ä¸¦è©•ä¼°æ¨¡å‹ï¼Œä¸¦ç”¨ä¾†é æ¸¬è¨ˆç¨‹è»Šè²»ã€‚</p>
<h1 id="explore-dataset"><a class="header-anchor" href="#explore-dataset">Â¶</a>Explore dataset</h1>
<p>åœ¨ GCP Console ä¸­æ‰“é–‹ BigQuery é é¢ï¼Œé•·å¾—åƒé€™å€‹æ¨£å­ï¼š<br>
å·¦å´é¸å–®æ‰¾ä¸åˆ°çš„åŒå­¸å¯ä»¥å¾ä¸Šæ–¹çš„æœå°‹æ¬„è¼¸å…¥ BigQuery ã€‚</p>
<img src="https://cdn.qwiklabs.com/vd3QNHGB4BAyHjAvOHw9qD0iqCPNaHAzY657z%2FGWLtY%3D" width="80%">
<p>æ ¹æ“šæ•™å­¸æ–‡ä»¶ï¼Œ BigQuery ä½¿ç”¨ç›¸å®¹ SQL 2011 standard çš„ SQL èªæ³•ä¾†æ“ä½œæ•¸æ“šï¼Œè©³ç´°çš„è¨Šæ¯å¯ä»¥åƒè€ƒ<a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/" target="_blank" rel="noopener">æ–‡ä»¶</a>ã€‚å°æ–¼ä¹‹å‰æ²’ç”¨é SQL çš„äºº(æˆ‘)ä¾†èªªï¼Œé€™å€‹éƒ¨åˆ†æˆ‘è¦ºå¾—ä¸¦ä¸æ˜¯å¤ªå¥½ä¸Šæ‰‹ï¼ŒèŠ±äº†å¥½å¹¾å¤©çš„æ™‚é–“ç ”ç©¶ã€‚</p>
<p>åœ¨ Query editor ä¸­è¼¸å…¥ SQL æŒ‡ä»¤å¾ŒæŒ‰ä¸‹ Run æŒ‰éˆ•ï¼Œç³»çµ±æœƒæŒ‰ç…§ SQL æŒ‡ä»¤å°‡è³‡æ–™æ’ˆå‡ºä¾†ï¼Œä¸¦é€éä¸‹æ–¹è¡¨æ ¼å‘ˆç¾çµæœã€‚ä¹Ÿå¯ä»¥è©¦è‘—ç”¨çœ‹çœ‹ Data Studio ï¼Œç•«æˆåœ–è¡¨ã€‚</p>
<p>å…ˆä¾†çœ‹çœ‹æ•¸æ“šé›†ä¸­çš„æ•¸æ“šé•·ä»€éº¼æ¨£å­ï¼Œåƒæ˜¯æ¯å€‹æœˆçš„ trips ç¸½æ•¸é‡ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#standardSQL</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  TIMESTAMP_TRUNC(pickup_datetime,</span><br><span class="line">    <span class="keyword">MONTH</span>) <span class="keyword">month</span>,</span><br><span class="line">  <span class="keyword">COUNT</span>(*) trips</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">  <span class="string">`bigquery-public-data.new_york.tlc_yellow_trips_2015`</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">  <span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">  <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>å¾ç¨‹å¼ç¢¼ä¸­å¯ä»¥çœ‹å‡ºæ•¸æ“šæ˜¯ä¾†è‡ª <code>bigquery-public-data.new_york.tlc_yellow_trips_2015</code> ï¼Œä¸¦ä½¿ç”¨ <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/timestamp_functions" target="_blank" rel="noopener">TIMESTAMP_TRUNC</a> å°‡æ™‚é–“æˆ³è½‰ç‚ºæœˆä»½ã€‚</p>
<p>è¦ç€è¦½æ•¸æ“šé›†çš„ç´°ç¯€éœ€è¦ä½¿ç”¨æ“æœ‰ BigQuery è³‡æºçš„å¸³è™Ÿ(é€™æ¨£æ‰å¯ä»¥è¨ˆè²»å•ŠXD)ï¼Œä¾‹å¦‚ Qwiklabs æä¾›çš„å¸³è™Ÿã€‚é€™æ¬¡ç”¨çš„æ•¸æ“šé›†ç´°ç¯€å¯ä»¥åœ¨ <a href="https://bigquery.cloud.google.com/table/nyc-tlc:yellow.trips?tab=preview" target="_blank" rel="noopener">Dataset Preview</a> æ‰¾åˆ°</p>
<p>æƒ³çŸ¥é“ BigQuery çš„å…¶ä»–çš„å…¬é–‹æ•¸æ“šé›†å¯ä»¥ä¾† <a href="https://cloud.google.com/bigquery/public-data/" target="_blank" rel="noopener">BigQuery Public-Data</a> æ‰¾æ‰¾ã€‚</p>
<p>ç­‰ Query å®Œæˆå¾Œï¼Œä¸‹æ–¹é¡¯ç¤ºçµæœç‚ºï¼š</p>
<img src="https://cdn.qwiklabs.com/i3PmHY7jPV1XuAIql%2FDlkUHWFWuPJLcW1VECFP9P%2BuI%3D" width="30%">
<p>æ¯å€‹æœˆéƒ½æœ‰å¤§ç´„ä¸€åƒè¬å¤šç­†çš„è³‡æ–™ã€‚</p>
<p>å†ä¾†çœ‹çœ‹ç´ç´„çš„è¨ˆç¨‹è»Šå¸æ©Ÿåœ¨ä¸€å¤©ä¸­ä¸åŒçš„æ™‚é–“é»ä¸Šï¼Œè·‘å¾—æœ‰å¤šå¿«ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#standardSQL</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  <span class="keyword">EXTRACT</span>(<span class="keyword">HOUR</span></span><br><span class="line">	<span class="keyword">FROM</span></span><br><span class="line">		pickup_datetime) <span class="keyword">hour</span>,</span><br><span class="line">  <span class="keyword">ROUND</span>(<span class="keyword">AVG</span>(trip_distance / TIMESTAMP_DIFF(dropoff_datetime,</span><br><span class="line">        pickup_datetime,</span><br><span class="line">        <span class="keyword">SECOND</span>))*<span class="number">3600</span>, <span class="number">1</span>) speed</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">  <span class="string">`bigquery-public-data.new_york.tlc_yellow_trips_2015`</span></span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">  trip_distance &gt; <span class="number">0</span></span><br><span class="line">  <span class="keyword">AND</span> fare_amount/trip_distance <span class="keyword">BETWEEN</span> <span class="number">2</span></span><br><span class="line">  <span class="keyword">AND</span> <span class="number">10</span></span><br><span class="line">  <span class="keyword">AND</span> dropoff_datetime &gt; pickup_datetime</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">  <span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">  <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>é€™æ®µç¨‹å¼è—‰ç”± <code>trip_distance</code> ã€ <code>pickup_datetime</code> ã€ <code>dropoff_datetime</code> é€™ä¸‰å€‹æ¬„ä½ä¾†è¨ˆç®—å‡ºè¨ˆç¨‹è»Šçš„å¹³å‡é€Ÿç‡ï¼Œä¸¦ä½¿ç”¨ ROUND å‡½æ•¸æ›æˆæ™‚é€Ÿã€‚<br>
æœ€å¾Œä½¿ç”¨ <code>GROUP BY 1</code> ï¼Œæ ¹æ“šç¬¬ä¸€æ¬„ hour ä¾†åˆ†ç¾¤ã€‚</p>
<p>çµæœåƒæ˜¯é€™å€‹æ¨£å­ï¼ŒåŠå¤œå‡Œæ™¨å¤§å¤¥å…’å‚¾å‘é£†è»Šã€‚</p>
<img src="https://cdn.qwiklabs.com/%2BF8Mj8HqPM9b8%2Fna1JYPy66xTKDcUu%2BQs1oh5Gy07A4%3D" width="10%">
<h1 id="training-dataset"><a class="header-anchor" href="#training-dataset">Â¶</a>Training dataset</h1>
<p>ç¾åœ¨ï¼Œæˆ‘å€‘æƒ³è¦è©¦è©¦ä»¥ä¸‹æ¬„ä½æ˜¯å¦æ˜¯å¥½çš„ feature ï¼Œæ±ºå®šä¾† train ä¸€ç™¼çœ‹çœ‹ï¼š</p>
<ul>
<li>Tolls Amount</li>
<li>Fare Amount</li>
<li>Hour of Day</li>
<li>Pick up address</li>
<li>Drop off address</li>
<li>Number of passengers</li>
</ul>
<p>æˆ‘å€‘å¿…é ˆæŠŠå®ƒå€‘æ’ˆå‡ºä¾†ï¼Œä¸¦ä¸”åšä¸€äº›æ•¸æ“šç¯©é¸ï¼Œå®Œæ•´ç¨‹å¼ç¢¼å¦‚ä¸‹:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#standardSQL</span></span><br><span class="line"><span class="keyword">WITH</span> params <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">    <span class="number">1</span> <span class="keyword">AS</span> TRAIN,</span><br><span class="line">    <span class="number">2</span> <span class="keyword">AS</span> EVAL</span><br><span class="line">    ),</span><br><span class="line"></span><br><span class="line">  daynames <span class="keyword">AS</span></span><br><span class="line">    (<span class="keyword">SELECT</span> [<span class="string">'Sun'</span>, <span class="string">'Mon'</span>, <span class="string">'Tues'</span>, <span class="string">'Wed'</span>, <span class="string">'Thurs'</span>, <span class="string">'Fri'</span>, <span class="string">'Sat'</span>] <span class="keyword">AS</span> daysofweek),</span><br><span class="line"></span><br><span class="line">  taxitrips <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    (tolls_amount + fare_amount) <span class="keyword">AS</span> total_fare,</span><br><span class="line">    daysofweek[ORDINAL(<span class="keyword">EXTRACT</span>(<span class="keyword">DAYOFWEEK</span> <span class="keyword">FROM</span> pickup_datetime))] <span class="keyword">AS</span> <span class="keyword">dayofweek</span>,</span><br><span class="line">    <span class="keyword">EXTRACT</span>(<span class="keyword">HOUR</span> <span class="keyword">FROM</span> pickup_datetime) <span class="keyword">AS</span> hourofday,</span><br><span class="line">    pickup_longitude <span class="keyword">AS</span> pickuplon,</span><br><span class="line">    pickup_latitude <span class="keyword">AS</span> pickuplat,</span><br><span class="line">    dropoff_longitude <span class="keyword">AS</span> dropofflon,</span><br><span class="line">    dropoff_latitude <span class="keyword">AS</span> dropofflat,</span><br><span class="line">    passenger_count <span class="keyword">AS</span> passengers</span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    <span class="string">`nyc-tlc.yellow.trips`</span>, daynames, params</span><br><span class="line">  <span class="keyword">WHERE</span></span><br><span class="line">    trip_distance &gt; <span class="number">0</span> <span class="keyword">AND</span> fare_amount &gt; <span class="number">0</span></span><br><span class="line">    <span class="keyword">AND</span> <span class="keyword">MOD</span>(<span class="keyword">ABS</span>(FARM_FINGERPRINT(<span class="keyword">CAST</span>(pickup_datetime <span class="keyword">AS</span> <span class="keyword">STRING</span>))),<span class="number">1000</span>) = params.TRAIN</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">SELECT</span> *</span><br><span class="line">  <span class="keyword">FROM</span> taxitrips</span><br></pre></td></tr></table></figure>
<p>é€™ä¸€æ®µä½¿ç”¨ <code>WITH...AS...</code> é–‹äº†ä¸‰å€‹ SubQuery ã€‚<br>
<code>params</code> èˆ‡ <code>daynames</code> åˆ†åˆ¥å°‡ <code>TRAIN</code> è·Ÿ æ˜ŸæœŸ ç­‰ã€Œå¸¸æ•¸ã€å®šç¾©å¥½ï¼Œè€Œæœ€å¾Œè¼¸å‡ºçš„æŸ¥è©¢å‰‡æ˜¯ç”± <code>taxitrips</code> è² è²¬ã€‚</p>
<p><code>params</code> ï¼š</p>
<img src="https://i.imgur.com/mETjvTd.png" width="20%">
<p><code>daynames</code> ï¼š</p>
<img src="https://i.imgur.com/5asAu7S.png" width="15%">
<p><code>taxitrips</code> ï¼š</p>
<img src="https://cdn.qwiklabs.com/9%2FORyElhKMLalupP%2FuG%2BZqE%2FTjLX4XYCXnvsEmGLang%3D" width="70%">
<p>åœ¨ <code>taxitrips</code> é€™å€‹æŸ¥è©¢ä¸­ï¼Œè—‰è‘— <code>WHERE</code> ä¾†ç¯©é¸è³‡æ–™ï¼š<br>
<code>trip_distance &gt; 0 AND fare_amount &gt; 0</code></p>
<p>ä¸¦ä»¥ä»¥ä¸‹æ¢ä»¶ä¾†å€åˆ† Training Set èˆ‡ Validation Set :</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOD(ABS(FARM_FINGERPRINT(CAST(pickup_datetime AS STRING))),1000) = params.TRAIN</span><br></pre></td></tr></table></figure>
<p>é€™è£¡ä½¿ç”¨äº†ä¸€å€‹ç‰¹åˆ¥çš„ <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/hash_functions" target="_blank" rel="noopener">FARM_FINGERPRINT</a> Hash å‡½æ•¸ï¼Œå¯ä»¥æŠŠå­—ä¸²æˆ–ä½å…ƒçµ„è½‰æˆé•·æ•´æ•¸ã€‚</p>
<p>é€™å€‹æ¢ä»¶å¼é‹ä½œæ–¹å¼ç‚ºï¼š<br>
æ—¥æœŸè½‰ç‚ºå­—ä¸² -&gt; è½‰ç‚ºé•·æ•´æ•¸çš„çµ•å°å€¼ -&gt; å–é™¤1000çš„é¤˜æ•¸ -&gt; åˆ¤æ–·ç­”æ¡ˆæ˜¯å¦ç‚ºparams.TRAINï¼Œä¹Ÿå°±æ˜¯1ã€‚<br>
æ ¹æ“šæ•™å­¸æ–‡ä»¶ï¼Œå¯ä»¥é¸å‡º 1/1000 çš„æ•¸æ“šä¾†ä½œç‚ºè¨“ç·´é›†ã€‚</p>
<h1 id="train-model"><a class="header-anchor" href="#train-model">Â¶</a>Train model</h1>
<h2 id="create-a-bigquery-dataset-to-store-models"><a class="header-anchor" href="#create-a-bigquery-dataset-to-store-models">Â¶</a>Create a BigQuery dataset to store models</h2>
<p>åœ¨è¨“ç·´ä¹‹å‰ï¼Œæˆ‘å€‘å¿…é ˆè¦é–‹ä¸€å€‹å¯ä»¥å­˜æ”¾è¨“ç·´å¥½çš„ model çš„ç©ºé–“ã€‚</p>
<p>åœ¨å·¦é‚Šçš„ BigQuery Resource é¸å–®ä¸­ï¼Œé¸æ“‡æœ€ä¸‹æ–¹çš„ ProjectID ï¼Œä½¿ç”¨ Qwiklabs å¸³è™Ÿçš„è©±çœ‹èµ·ä¾†æœƒåƒ <code>qwiklabs-gcp-xxx</code> ã€‚</p>
<p>é»é¸å³ä¸‹é‚Šçš„ CREATE DATSET ï¼Œä¸¦å–å€‹åå­—ï¼Œå°±å« taxi å¥½äº†ã€‚</p>
<img src="https://cdn.qwiklabs.com/QGOFCQMb3UNnOf2dByXcmcH7%2BX6xwnoQFX0Fdo7fRLU%3D" width="70%">
<p>å¥½äº†ä¹‹å¾Œé» Create dataset å°±å¯ä»¥äº†ã€‚</p>
<h2 id="create-and-train-a-model"><a class="header-anchor" href="#create-and-train-a-model">Â¶</a>Create and train a model</h2>
<p>å…ˆä¸Š Query ç¨‹å¼ç¢¼ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#standardSQL</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">or</span> <span class="keyword">REPLACE</span> <span class="keyword">MODEL</span> taxi.taxifare_model</span><br><span class="line">OPTIONS</span><br><span class="line">  (model_type=<span class="string">'linear_reg'</span>, labels=[<span class="string">'total_fare'</span>]) <span class="keyword">AS</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä»¥ä¸‹è·Ÿä¸Šä¸€æ®µçš„ç¨‹å¼ç¢¼ç›¸åŒ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> params <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">    <span class="number">1</span> <span class="keyword">AS</span> TRAIN,</span><br><span class="line">    <span class="number">2</span> <span class="keyword">AS</span> EVAL</span><br><span class="line">    ),</span><br><span class="line"></span><br><span class="line">  daynames <span class="keyword">AS</span></span><br><span class="line">    (<span class="keyword">SELECT</span> [<span class="string">'Sun'</span>, <span class="string">'Mon'</span>, <span class="string">'Tues'</span>, <span class="string">'Wed'</span>, <span class="string">'Thurs'</span>, <span class="string">'Fri'</span>, <span class="string">'Sat'</span>] <span class="keyword">AS</span> daysofweek),</span><br><span class="line"></span><br><span class="line">  taxitrips <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    (tolls_amount + fare_amount) <span class="keyword">AS</span> total_fare,</span><br><span class="line">    daysofweek[ORDINAL(<span class="keyword">EXTRACT</span>(<span class="keyword">DAYOFWEEK</span> <span class="keyword">FROM</span> pickup_datetime))] <span class="keyword">AS</span> <span class="keyword">dayofweek</span>,</span><br><span class="line">    <span class="keyword">EXTRACT</span>(<span class="keyword">HOUR</span> <span class="keyword">FROM</span> pickup_datetime) <span class="keyword">AS</span> hourofday,</span><br><span class="line">    pickup_longitude <span class="keyword">AS</span> pickuplon,</span><br><span class="line">    pickup_latitude <span class="keyword">AS</span> pickuplat,</span><br><span class="line">    dropoff_longitude <span class="keyword">AS</span> dropofflon,</span><br><span class="line">    dropoff_latitude <span class="keyword">AS</span> dropofflat,</span><br><span class="line">    passenger_count <span class="keyword">AS</span> passengers</span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    <span class="string">`nyc-tlc.yellow.trips`</span>, daynames, params</span><br><span class="line">  <span class="keyword">WHERE</span></span><br><span class="line">    trip_distance &gt; <span class="number">0</span> <span class="keyword">AND</span> fare_amount &gt; <span class="number">0</span></span><br><span class="line">    <span class="keyword">AND</span> <span class="keyword">MOD</span>(<span class="keyword">ABS</span>(FARM_FINGERPRINT(<span class="keyword">CAST</span>(pickup_datetime <span class="keyword">AS</span> <span class="keyword">STRING</span>))),<span class="number">1000</span>) = params.TRAIN</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">SELECT</span> *</span><br><span class="line">  <span class="keyword">FROM</span> taxitrips</span><br></pre></td></tr></table></figure>
<p>åœ¨é€™æ®µç¨‹å¼ç¢¼ä¸­ï¼Œæˆ‘å€‘å‰µé€ äº†ä¸€å€‹ model ï¼š taxi.taxifare_model ï¼Œä¹Ÿå°±æ˜¯éš¸å±¬æ–¼å‰›å‰µå»ºçš„ taxi ç©ºé–“ä¹‹ä¸‹ã€‚<br>
OPTIONS æŒ‡å®šäº† model çš„è¨“ç·´æ–¹å¼ä»¥åŠæƒ³é æ¸¬çš„ç›®æ¨™ã€‚<br>
BigQuery ML ç›®å‰åªæä¾›ä¸‰ç¨®æ©Ÿå™¨å­¸ç¿’æ¼”ç®—æ³•ï¼Œåˆ†åˆ¥æ˜¯ <code>linear_reg</code> ã€ <code>logistic_reg</code> ä»¥åŠ <code>kmeans</code> ã€‚<br>
åœ¨é€™å€‹ç¯„ä¾‹ä¸­æˆ‘å€‘é æ¸¬çš„ç›®æ¨™æ˜¯å€‹é€£çºŒçš„æ•¸å€¼ï¼Œæ•…ç·šæ€§å›æ­¸ <code>linear_reg</code> ç¬¦åˆæˆ‘å€‘çš„éœ€æ±‚ã€‚<br>
æ¼”ç®—æ³•æœ¬èº«ä¹Ÿæœ‰å„ç¨®çš„åƒæ•¸å¯ä»¥èª¿æ•´ï¼Œæ›´è©³ç´°çš„å…§å®¹å°±äº¤çµ¦ <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-create" target="_blank" rel="noopener">æ–‡æª”</a> ä¾†è§£æ±ºã€‚</p>
<p>è·‘å®Œå¾Œå¯ä»¥çœ‹åˆ°å‰›å‰µå»ºçš„ taxi ä¸‹é¢è¹¦å‡º <code>taxifare_model</code> ã€‚</p>
<img src="https://cdn.qwiklabs.com/3e%2B%2Bn9FtlJ4zZDbP1edDClbadjTZmcifikRDzSbd3fA%3D" width="35%">
<h1 id="evaluate-model-performance"><a class="header-anchor" href="#evaluate-model-performance">Â¶</a>Evaluate model performance</h1>
<p>ä¸€æ¨£å…ˆä¸Š Query ç¨‹å¼ç¢¼ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#standardSQL</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  <span class="keyword">SQRT</span>(mean_squared_error) <span class="keyword">AS</span> rmse</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">  ML.EVALUATE(<span class="keyword">MODEL</span> taxi.taxifare_model,</span><br><span class="line">  (</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ­¤è™•èˆ‡ä¸Šä¸Šæ®µç¨‹å¼ç¢¼é›·åŒï¼Œä½†ä½¿ç”¨ params.EVAL ä½œç‚ºç¯©é¸æ¢ä»¶ï¼Œè«‹çœ‹33è¡Œ</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">WITH</span> params <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">    <span class="number">1</span> <span class="keyword">AS</span> TRAIN,</span><br><span class="line">    <span class="number">2</span> <span class="keyword">AS</span> EVAL</span><br><span class="line">    ),</span><br><span class="line"></span><br><span class="line">  daynames <span class="keyword">AS</span></span><br><span class="line">    (<span class="keyword">SELECT</span> [<span class="string">'Sun'</span>, <span class="string">'Mon'</span>, <span class="string">'Tues'</span>, <span class="string">'Wed'</span>, <span class="string">'Thurs'</span>, <span class="string">'Fri'</span>, <span class="string">'Sat'</span>] <span class="keyword">AS</span> daysofweek),</span><br><span class="line"></span><br><span class="line">  taxitrips <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    (tolls_amount + fare_amount) <span class="keyword">AS</span> total_fare,</span><br><span class="line">    daysofweek[ORDINAL(<span class="keyword">EXTRACT</span>(<span class="keyword">DAYOFWEEK</span> <span class="keyword">FROM</span> pickup_datetime))] <span class="keyword">AS</span> <span class="keyword">dayofweek</span>,</span><br><span class="line">    <span class="keyword">EXTRACT</span>(<span class="keyword">HOUR</span> <span class="keyword">FROM</span> pickup_datetime) <span class="keyword">AS</span> hourofday,</span><br><span class="line">    pickup_longitude <span class="keyword">AS</span> pickuplon,</span><br><span class="line">    pickup_latitude <span class="keyword">AS</span> pickuplat,</span><br><span class="line">    dropoff_longitude <span class="keyword">AS</span> dropofflon,</span><br><span class="line">    dropoff_latitude <span class="keyword">AS</span> dropofflat,</span><br><span class="line">    passenger_count <span class="keyword">AS</span> passengers</span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    <span class="string">`nyc-tlc.yellow.trips`</span>, daynames, params</span><br><span class="line">  <span class="keyword">WHERE</span></span><br><span class="line">    trip_distance &gt; <span class="number">0</span> <span class="keyword">AND</span> fare_amount &gt; <span class="number">0</span></span><br><span class="line">    <span class="keyword">AND</span> <span class="keyword">MOD</span>(<span class="keyword">ABS</span>(FARM_FINGERPRINT(<span class="keyword">CAST</span>(pickup_datetime <span class="keyword">AS</span> <span class="keyword">STRING</span>))),<span class="number">1000</span>) = params.EVAL</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">SELECT</span> *</span><br><span class="line">  <span class="keyword">FROM</span> taxitrips</span><br><span class="line"></span><br><span class="line">  ))</span><br></pre></td></tr></table></figure>
<p>æ­¤æ®µä½¿ç”¨é©—è­‰é›† <code>params.EVAL</code> ã€ <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-evaluate" target="_blank" rel="noopener">ML.EVALUATE</a> å‡½æ•¸è¨ˆç®—æ¨æ¸¬èˆ‡æ­£ç¢ºç­”æ¡ˆä¹‹é–“çš„ Root mean square error ï¼Œæ•¸å€¼è¶Šå°ä»£è¡¨æ¨¡å‹è¶Šæº–ç¢ºã€‚</p>
<p>çµæœä¾†åˆ° 9.5 å·¦å³ã€‚</p>
<h1 id="prediction"><a class="header-anchor" href="#prediction">Â¶</a>Prediction</h1>
<p>é‚£ä¾†çœ‹çœ‹é æ¸¬çš„æ•¸å€¼å§ï¼æŠŠä¸Šä¸€æ®µç¨‹å¼ç¢¼æ›æˆä½¿ç”¨ <a href="https://cloud.google.com/bigquery-ml/docs/reference/standard-sql/bigqueryml-syntax-predict" target="_blank" rel="noopener">ML.PREDICT</a> å‡½æ•¸å°±å¯ä»¥äº†ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#standardSQL</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">*</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">  ML.PREDICT(<span class="keyword">MODEL</span> <span class="string">`taxi.taxifare_model`</span>,</span><br><span class="line">   (</span><br><span class="line"></span><br><span class="line"> <span class="keyword">WITH</span> params <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">    <span class="number">1</span> <span class="keyword">AS</span> TRAIN,</span><br><span class="line">    <span class="number">2</span> <span class="keyword">AS</span> EVAL</span><br><span class="line">    ),</span><br><span class="line"></span><br><span class="line">  daynames <span class="keyword">AS</span></span><br><span class="line">    (<span class="keyword">SELECT</span> [<span class="string">'Sun'</span>, <span class="string">'Mon'</span>, <span class="string">'Tues'</span>, <span class="string">'Wed'</span>, <span class="string">'Thurs'</span>, <span class="string">'Fri'</span>, <span class="string">'Sat'</span>] <span class="keyword">AS</span> daysofweek),</span><br><span class="line"></span><br><span class="line">  taxitrips <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    (tolls_amount + fare_amount) <span class="keyword">AS</span> total_fare,</span><br><span class="line">    daysofweek[ORDINAL(<span class="keyword">EXTRACT</span>(<span class="keyword">DAYOFWEEK</span> <span class="keyword">FROM</span> pickup_datetime))] <span class="keyword">AS</span> <span class="keyword">dayofweek</span>,</span><br><span class="line">    <span class="keyword">EXTRACT</span>(<span class="keyword">HOUR</span> <span class="keyword">FROM</span> pickup_datetime) <span class="keyword">AS</span> hourofday,</span><br><span class="line">    pickup_longitude <span class="keyword">AS</span> pickuplon,</span><br><span class="line">    pickup_latitude <span class="keyword">AS</span> pickuplat,</span><br><span class="line">    dropoff_longitude <span class="keyword">AS</span> dropofflon,</span><br><span class="line">    dropoff_latitude <span class="keyword">AS</span> dropofflat,</span><br><span class="line">    passenger_count <span class="keyword">AS</span> passengers</span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    <span class="string">`nyc-tlc.yellow.trips`</span>, daynames, params</span><br><span class="line">  <span class="keyword">WHERE</span></span><br><span class="line">    trip_distance &gt; <span class="number">0</span> <span class="keyword">AND</span> fare_amount &gt; <span class="number">0</span></span><br><span class="line">    <span class="keyword">AND</span> <span class="keyword">MOD</span>(<span class="keyword">ABS</span>(FARM_FINGERPRINT(<span class="keyword">CAST</span>(pickup_datetime <span class="keyword">AS</span> <span class="keyword">STRING</span>))),<span class="number">1000</span>) = params.EVAL</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">SELECT</span> *</span><br><span class="line">  <span class="keyword">FROM</span> taxitrips</span><br><span class="line"></span><br><span class="line">));</span><br></pre></td></tr></table></figure>
<p>è¼¸å‡ºå¦‚ä¸‹ï¼Œé æ¸¬çš„æ•¸å€¼èˆ‡çœŸå¯¦æ•¸æ“šçœ‹ä¾†æœ‰æ®µå·®è·ï¼š</p>
<img src="https://cdn.qwiklabs.com/vOie0YpofU3oI7zMJrG9OJT%2Bom89nokwCtceenccSc0%3D" width="80%">
<h1 id="improving-the-model"><a class="header-anchor" href="#improving-the-model">Â¶</a>Improving the model</h1>
<p>æ ¹æ“šå¯¦é©—çµæœï¼Œçµæœçœ‹èµ·ä¾†ä¸¦ä¸æ˜¯é‚£éº¼å„ªç§€ã€‚</p>
<p>æˆ‘å€‘å†è§€å¯Ÿä¸€æ¬¡æƒ³é æ¸¬çš„ç›®æ¨™ä¹‹ä¸€ ï¼ï¼ <code>fare_amount</code> ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  <span class="keyword">COUNT</span>(fare_amount) <span class="keyword">AS</span> num_fares,</span><br><span class="line">  <span class="keyword">MIN</span>(fare_amount) <span class="keyword">AS</span> low_fare,</span><br><span class="line">  <span class="keyword">MAX</span>(fare_amount) <span class="keyword">AS</span> high_fare,</span><br><span class="line">  <span class="keyword">AVG</span>(fare_amount) <span class="keyword">AS</span> avg_fare,</span><br><span class="line">  <span class="keyword">STDDEV</span>(fare_amount) <span class="keyword">AS</span> <span class="keyword">stddev</span></span><br><span class="line"><span class="keyword">FROM</span> <span class="string">`nyc-tlc.yellow.trips`</span></span><br></pre></td></tr></table></figure>
<img src="https://cdn.qwiklabs.com/uX%2Fr9WrJRi7usPBEaElFe7gFgAMrm0Q3exGSbGCeV1I%3D" width="70%">
<p>æŒ–è³½ï¼Œ Maximum ç«Ÿç„¶è¡åˆ° 503325 ï¼Œèª°æœƒèŠ±é€™éº¼å¤šéŒ¢æ­è¨ˆç¨‹è»Šå•Š?</p>
<p>æˆ‘å€‘å¿…é ˆè¦å°‡é€™ç¨®å¥‡æ€ªçš„æ•¸æ“šæ¸…æ‰ï¼</p>
<p>â€¦ â€¦</p>
<p>æœ‰æ›¸å‰‡é•·ï¼Œç„¡æ›¸å‰‡çŸ­ã€‚æœ€å¾Œçš„ç¯©é¸å¦‚ä¸‹ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">WHERE trip_distance &gt; 0 AND fare_amount BETWEEN 6 and 200</span><br><span class="line">    AND pickup_longitude &gt; -75 #limiting of the distance the taxis travel out</span><br><span class="line">    AND pickup_longitude &lt; -73</span><br><span class="line">    AND dropoff_longitude &gt; -75</span><br><span class="line">    AND dropoff_longitude &lt; -73</span><br><span class="line">    AND pickup_latitude &gt; 40</span><br><span class="line">    AND pickup_latitude &lt; 42</span><br><span class="line">    AND dropoff_latitude &gt; 40</span><br><span class="line">    AND dropoff_latitude &lt; 42</span><br></pre></td></tr></table></figure>
<p>å†ä¾† train ä¸€ç™¼ï¼</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">MODEL</span> taxi.taxifare_model_2</span><br><span class="line">OPTIONS</span><br><span class="line">  (model_type=<span class="string">'linear_reg'</span>, labels=[<span class="string">'total_fare'</span>]) <span class="keyword">AS</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> params <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">    <span class="number">1</span> <span class="keyword">AS</span> TRAIN,</span><br><span class="line">    <span class="number">2</span> <span class="keyword">AS</span> EVAL</span><br><span class="line">    ),</span><br><span class="line"></span><br><span class="line">  daynames <span class="keyword">AS</span></span><br><span class="line">    (<span class="keyword">SELECT</span> [<span class="string">'Sun'</span>, <span class="string">'Mon'</span>, <span class="string">'Tues'</span>, <span class="string">'Wed'</span>, <span class="string">'Thurs'</span>, <span class="string">'Fri'</span>, <span class="string">'Sat'</span>] <span class="keyword">AS</span> daysofweek),</span><br><span class="line"></span><br><span class="line">  taxitrips <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    (tolls_amount + fare_amount) <span class="keyword">AS</span> total_fare,</span><br><span class="line">    daysofweek[ORDINAL(<span class="keyword">EXTRACT</span>(<span class="keyword">DAYOFWEEK</span> <span class="keyword">FROM</span> pickup_datetime))] <span class="keyword">AS</span> <span class="keyword">dayofweek</span>,</span><br><span class="line">    <span class="keyword">EXTRACT</span>(<span class="keyword">HOUR</span> <span class="keyword">FROM</span> pickup_datetime) <span class="keyword">AS</span> hourofday,</span><br><span class="line">    <span class="keyword">SQRT</span>(<span class="keyword">POW</span>((pickup_longitude - dropoff_longitude),<span class="number">2</span>) + <span class="keyword">POW</span>(( pickup_latitude - dropoff_latitude), <span class="number">2</span>)) <span class="keyword">as</span> dist, <span class="comment">#Euclidean distance between pickup and drop off</span></span><br><span class="line">    <span class="keyword">SQRT</span>(<span class="keyword">POW</span>((pickup_longitude - dropoff_longitude),<span class="number">2</span>)) <span class="keyword">as</span> longitude, <span class="comment">#Euclidean distance between pickup and drop off in longitude</span></span><br><span class="line">    <span class="keyword">SQRT</span>(<span class="keyword">POW</span>((pickup_latitude - dropoff_latitude), <span class="number">2</span>)) <span class="keyword">as</span> latitude, <span class="comment">#Euclidean distance between pickup and drop off in latitude</span></span><br><span class="line">    passenger_count <span class="keyword">AS</span> passengers</span><br><span class="line">  <span class="keyword">FROM</span></span><br><span class="line">    <span class="string">`nyc-tlc.yellow.trips`</span>, daynames, params</span><br><span class="line"><span class="keyword">WHERE</span> trip_distance &gt; <span class="number">0</span> <span class="keyword">AND</span> fare_amount <span class="keyword">BETWEEN</span> <span class="number">6</span> <span class="keyword">and</span> <span class="number">200</span></span><br><span class="line">    <span class="keyword">AND</span> pickup_longitude &gt; <span class="number">-75</span> <span class="comment">#limiting of the distance the taxis travel out</span></span><br><span class="line">    <span class="keyword">AND</span> pickup_longitude &lt; <span class="number">-73</span></span><br><span class="line">    <span class="keyword">AND</span> dropoff_longitude &gt; <span class="number">-75</span></span><br><span class="line">    <span class="keyword">AND</span> dropoff_longitude &lt; <span class="number">-73</span></span><br><span class="line">    <span class="keyword">AND</span> pickup_latitude &gt; <span class="number">40</span></span><br><span class="line">    <span class="keyword">AND</span> pickup_latitude &lt; <span class="number">42</span></span><br><span class="line">    <span class="keyword">AND</span> dropoff_latitude &gt; <span class="number">40</span></span><br><span class="line">    <span class="keyword">AND</span> dropoff_latitude &lt; <span class="number">42</span></span><br><span class="line">    <span class="keyword">AND</span> <span class="keyword">MOD</span>(<span class="keyword">ABS</span>(FARM_FINGERPRINT(<span class="keyword">CAST</span>(pickup_datetime <span class="keyword">AS</span> <span class="keyword">STRING</span>))),<span class="number">1000</span>) = params.TRAIN</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">SELECT</span> *</span><br><span class="line">  <span class="keyword">FROM</span> taxitrips</span><br></pre></td></tr></table></figure>
<p>é©—è­‰ä¸€ä¸‹ï¼Œ RMSE çµæœä¾†åˆ° 5.1 å·¦å³ï¼Œå¸¥å‘€ï¼</p>
<h1 id="outro"><a class="header-anchor" href="#outro">Â¶</a>Outro</h1>
<p>èº«ç‚ºä¸€å€‹å¥½çš„æ©Ÿå™¨å­¸ç¿’å·¥ç¨‹å¸«ï¼Œè¦åšçš„å·¥ä½œé‚„æœ‰å¾ˆå¤šã€‚<br>
Qwiklabs çš„æ•™å­¸å°±åˆ°æ­¤ç‚ºæ­¢ï¼Œä¸€å€‹å°æ™‚çš„æ™‚é™ä¹Ÿéå¾—å·®ä¸å¤šäº†ï¼</p>
<p>ä»¥å€‹äººçš„è§€é»è€Œè¨€ï¼Œ BQML èƒ½ä½¿ç”¨çš„åŠŸèƒ½ä¼¼ä¹é‚„æ˜¯æŒºæœ‰é™ã€‚<br>
ä¸éBQçš„å¼·é …åœ¨æ–¼è™•ç†è¶…å¤§é‡çš„æ•¸æ“šï¼Œè¦æ·±å…¥ç ”ç©¶æ¨¡å‹çš„è©±å¯ä»¥åˆ° <a href="https://colab.research.google.com/" target="_blank" rel="noopener">Colab</a> ä¾†çœ‹çœ‹ã€‚</p>

      </div>
        
          <section class="meta" id="footer-meta">
            <hr>
            <div class="new-meta-box">
              
                <div class="new-meta-item date" itemprop="dateUpdated" datetime="2019-05-16T14:44:13+08:00">
                  <a class="notlink">
                    <i class="fas fa-pencil-alt" aria-hidden="true"></i>
                    2019-05-16
                  </a>
                </div>
              
              
                
                <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Google-Could-Platform/"><i class="fas fa-hashtag" aria-hidden="true"></i>&nbsp;Google Could Platform</a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/SQL/"><i class="fas fa-hashtag" aria-hidden="true"></i>&nbsp;SQL</a></div>
              
              
            </div>
          </section>
        

        
            <div class="prev-next">
                
                    <section class="prev">
                        <span class="art-item-left">
                            <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;ä¸Šä¸€é </h6>
                            <h4>
                                <a href="/2019/05/15/androidDI/" rel="prev" title="å’–å•¡çš„æ•…äº‹ï¼š ä¾è³´æ³¨å…¥ã€Daggerã€Android">
                                  
                                      å’–å•¡çš„æ•…äº‹ï¼š ä¾è³´æ³¨å…¥ã€Daggerã€Android
                                  
                                </a>
                            </h4>
                            
                                
                                <h6 class="tags">
                                    <a class="tag" href="/tags/Android-native/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>Android native</a> <a class="tag" href="/tags/Dagger2/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>Dagger2</a> <a class="tag" href="/tags/Dependency-injection/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>Dependency injection</a>
                                </h6>
                            
                        </span>
                    </section>
                
                
                    <section class="next">
                        <span class="art-item-right" aria-hidden="true">
                            <h6>ä¸‹ä¸€é &nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                            <h4>
                                <a href="/2019/04/18/double-check-locking/" rel="prev" title="åŸ·è¡Œç·’å®‰å…¨ Double-checked Locking">
                                    
                                        åŸ·è¡Œç·’å®‰å…¨ Double-checked Locking
                                    
                                </a>
                            </h4>
                            
                                
                                <h6 class="tags">
                                    <a class="tag" href="/tags/Java/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>Java</a> <a class="tag" href="/tags/Kotlin/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>Kotlin</a>
                                </h6>
                            
                        </span>
                    </section>
                
            </div>
        

    </section>

</article>

<!-- æ ¹æ®é¡µé¢mathjaxå˜é‡å†³å®šæ˜¯å¦åŠ è½½MathJaxæ•°å­¦å…¬å¼js -->


<br>

<!-- æ˜¾ç¤ºæ¨èæ–‡ç« å’Œè¯„è®º -->



  <article class="post white-box comments">
    <section class="article typo">
      
      
        <h4><i class="fas fa-comments fa-fw" aria-hidden="true"></i>&nbsp;è©•è«–</h4>
        
          <section id="comments">
            <div id="disqus_thread">
              âš ï¸  ç„¡æ³•åŠ è¼‰è©•è«–ç³»çµ±ï¼Œè«‹ç¢ºä¿æ‚¨çš„ç¶²çµ¡èƒ½å¤ æ­£å¸¸è¨ªå• <a href="https://disqus.com">Disqus</a> ã€‚
            </div>
          </section>
        
        
        
      
    </section>
  </article>



<script>
    window.subData = {
        title: 'ML Study Jam1:ä½¿ç”¨ BigQueryMLé æ¸¬è¨ˆç¨‹è»Šè²»ç‡',
        tools: true
    }
</script>


        </div>
        <aside class='l_side'>
            
  
  
    
      
      
        <section class="author">
  <div class="content pure">
    
      <div class="avatar">
        <img class="avatar" src="/images/Dora.jpg">
      </div>
    
    
      <div class="text">
        
          <h2>è²“åœˆéƒ¨è½</h2>
        
        
          <p>å¯«å€‹ç­†è¨˜çµ¦è‡ªå·±çœ‹<br>
ä½ ä¹Ÿå¯ä»¥é †ä¾¿çœ‹çœ‹</p>

        
        
      </div>
    
    
      <div class="social-wrapper">
        
          
            <a href="https://github.com/DarKArieS" class="social flat-btn" target="_blank" rel="external"><i class="social fab fa-github" aria-hidden="true"></i></a>
          
        
      </div>
    
  </div>
</section>

      
    
  
    
      
      
        
  <section class="category">
    
<header class="pure">
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;æ‰€æœ‰åˆ†é¡</div>
  
</header>

    <div class="content pure">
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/Android-Note/" href="/categories/Android-Note/"><div class="name">Android Note</div><div class="badge">(4)</div></a></li>
        
          <li><a class="flat-box" title="/categories/C/" href="/categories/C/"><div class="name">C++</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Design-pattern/" href="/categories/Design-pattern/"><div class="name">Design pattern</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Google-Could-Platform/" href="/categories/Google-Could-Platform/"><div class="name">Google Could Platform</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Hexo/" href="/categories/Hexo/"><div class="name">Hexo</div><div class="badge">(2)</div></a></li>
        
      </ul>
    </div>
  </section>


      
    
  
    
      
      
        
  <section class="toc-wrapper">
    
<header class="pure">
  <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;æ–‡ç« ç›®éŒ„</div>
  
    <div class="wrapper"><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div>
  
</header>

    <div class="content pure">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#overview"><span class="toc-text">Â¶Overview</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#explore-dataset"><span class="toc-text">Â¶Explore dataset</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#training-dataset"><span class="toc-text">Â¶Training dataset</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#train-model"><span class="toc-text">Â¶Train model</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#create-a-bigquery-dataset-to-store-models"><span class="toc-text">Â¶Create a BigQuery dataset to store models</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#create-and-train-a-model"><span class="toc-text">Â¶Create and train a model</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#evaluate-model-performance"><span class="toc-text">Â¶Evaluate model performance</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#prediction"><span class="toc-text">Â¶Prediction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#improving-the-model"><span class="toc-text">Â¶Improving the model</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#outro"><span class="toc-text">Â¶Outro</span></a></li></ol>
    </div>
  </section>


      
    
  


        </aside>
        <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
    </div>
    <footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="https://github.com/DarKArieS" class="social fab fa-github flat-btn" target="_blank" rel="external"></a>
        
      
    </div>
  
  <br>
  <div><p>åšå®¢å…§å®¹éµå¾ª <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh_TW">å§“åæ¨™ç¤º-éå•†æ¥­æ€§-ç›¸åŒæ–¹å¼åˆ†äº« 4.0 åœ‹éš› (CC BY-NC-SA 4.0) å”è­°</a></p>
</div>
  <div>æœ¬ç«™ä½¿ç”¨ <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a> ä½œç‚ºä¸»é¡Œï¼Œç¸½è¨ªå•é‡ç‚º <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span> æ¬¡ã€‚
  </div>
</footer>

    <script>setLoadingBarProgress(80);</script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>


  
    <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
    <script type="text/javascript">
      $(function() {
        const $reveal = $('.reveal');
    		if ($reveal.length === 0) return;
    		const sr = ScrollReveal({ distance: 0 });
    		sr.reveal('.reveal');
      });
    </script>
  
  
    <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
    <script type="text/javascript">
      $(function() {
        Waves.attach('.flat-btn', ['waves-button']);
        Waves.attach('.float-btn', ['waves-button', 'waves-float']);
        Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
        Waves.attach('.flat-box', ['waves-block']);
        Waves.attach('.float-box', ['waves-block', 'waves-float']);
        Waves.attach('.waves-image');
        Waves.init();
      });
    </script>
  
  
    <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>
  
  
    <!-- fastclick -->
    <script src="https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        FastClick.attach(document.body)
      }, false)
    </script>
  
  

  
  
    
      
        <script>
          var disqus_shortname = 'nekorings-blog';
          
            var disqus_url = 'http://yoursite.com/2019/05/13/gcpmljam1/';
          
          (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      
      
      
    
  
  
    <script src="/js/app.js"></script>
<script src="/js/search.js"></script>
  






    <script>setLoadingBarProgress(100);</script>
</body>
</html>
